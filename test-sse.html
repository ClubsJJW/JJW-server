<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SSE í…ŒìŠ¤íŠ¸</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-bottom: 10px;
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 20px 0;
        font-weight: bold;
      }
      .status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.connecting {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .info {
        background: #e7f3ff;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        border-left: 4px solid #2196f3;
      }
      .events {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        max-height: 400px;
        overflow-y: auto;
      }
      .event {
        padding: 10px;
        margin: 10px 0;
        background: white;
        border-radius: 5px;
        border-left: 3px solid #2196f3;
        animation: slideIn 0.3s ease;
      }
      .event.hello {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-left: 3px solid #ffd700;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }
      .event.hello .event-time {
        color: #fff;
        opacity: 0.9;
      }
      .event.hello .event-data {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: bold;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .event-time {
        color: #666;
        font-size: 0.9em;
      }
      .event-data {
        margin-top: 5px;
        font-family: monospace;
        background: #f5f5f5;
        padding: 8px;
        border-radius: 3px;
        overflow-x: auto;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }
      button.primary {
        background: #2196f3;
        color: white;
      }
      button.primary:hover {
        background: #1976d2;
      }
      button.danger {
        background: #f44336;
        color: white;
      }
      button.danger:hover {
        background: #d32f2f;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .controls {
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸš€ SSE í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸</h1>

      <div class="info">
        <strong>ğŸ“Œ ì´ í˜ì´ì§€ëŠ” SSE ì—°ê²° í…ŒìŠ¤íŠ¸ìš©ì…ë‹ˆë‹¤</strong><br />
        ì—°ê²°í•˜ë©´ ì„œë²„ì—ì„œ ë³´ë‚´ëŠ” ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>

      <div id="status" class="status connecting">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>

      <div class="info">
        <strong>í´ë¼ì´ì–¸íŠ¸ ID:</strong> <span id="clientId">-</span><br />
        <strong>ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸ ìˆ˜:</strong> <span id="clientCount">-</span>
      </div>

      <div class="controls">
        <button id="connectBtn" class="primary" onclick="connectSSE()">
          ì—°ê²°í•˜ê¸°
        </button>
        <button
          id="disconnectBtn"
          class="danger"
          onclick="disconnectSSE()"
          disabled
        >
          ì—°ê²° ëŠê¸°
        </button>
        <button class="primary" onclick="checkStatus()">ì„œë²„ ìƒíƒœ í™•ì¸</button>
        <button class="primary" onclick="clearEvents()">ì´ë²¤íŠ¸ ì§€ìš°ê¸°</button>
      </div>

      <h3>ğŸ“¨ ìˆ˜ì‹ ëœ ì´ë²¤íŠ¸:</h3>
      <div id="events" class="events">
        <p style="color: #999">ì•„ì§ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    </div>

    <script>
      let eventSource = null;
      let clientId = null;
      let eventCount = 0;

      // í´ë¼ì´ì–¸íŠ¸ ID ìƒì„±
      function generateClientId() {
        return 'test-' + Math.random().toString(36).substr(2, 9);
      }

      // ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateStatus(status, className) {
        const statusEl = document.getElementById('status');
        statusEl.textContent = 'ìƒíƒœ: ' + status;
        statusEl.className = 'status ' + className;
      }

      // SSE ì—°ê²°
      function connectSSE() {
        if (eventSource) {
          alert('ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤!');
          return;
        }

        clientId = generateClientId();
        document.getElementById('clientId').textContent = clientId;

        updateStatus('ì—°ê²° ì¤‘...', 'connecting');

        // SSE ì—°ê²° ìƒì„±
        eventSource = new EventSource(
          `http://localhost:3090/sse/connect?clientId=${clientId}`,
        );

        eventSource.onopen = function () {
          console.log('âœ… SSE ì—°ê²° ì„±ê³µ');
          updateStatus('ì—°ê²°ë¨ âœ…', 'connected');
          document.getElementById('connectBtn').disabled = true;
          document.getElementById('disconnectBtn').disabled = false;
          addEvent('ì‹œìŠ¤í…œ', 'ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          checkStatus();
        };

        eventSource.onmessage = function (event) {
          console.log('ğŸ“¨ ì´ë²¤íŠ¸ ìˆ˜ì‹ :', event);
          eventCount++;

          try {
            const data = JSON.parse(event.data);

            // typeì´ 'hello'ì¸ ê²½ìš° íŠ¹ë³„í•˜ê²Œ í‘œì‹œ
            if (data.type === 'hello') {
              addEvent(
                `ğŸ‰ HELLO_TEXT #${eventCount}`,
                `ğŸ“£ ${data.message}\n\nâ° ${data.timestamp}\nğŸ‘¥ ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸: ${data.connectedClients}ëª…`,
                'hello',
              );
            } else {
              addEvent(
                `ì´ë²¤íŠ¸ #${eventCount}`,
                JSON.stringify(data, null, 2),
                'data',
              );
            }
          } catch (e) {
            addEvent(`ì´ë²¤íŠ¸ #${eventCount}`, event.data, 'data');
          }
        };

        eventSource.onerror = function (error) {
          console.error('âŒ SSE ì˜¤ë¥˜:', error);
          updateStatus('ì—°ê²° ì˜¤ë¥˜ âŒ', 'disconnected');
          addEvent('ì˜¤ë¥˜', 'SSE ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');

          // EventSourceëŠ” ìë™ìœ¼ë¡œ ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤
          if (eventSource.readyState === EventSource.CLOSED) {
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
          }
        };
      }

      // SSE ì—°ê²° í•´ì œ
      function disconnectSSE() {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
          updateStatus('ì—°ê²° ëŠê¹€', 'disconnected');
          document.getElementById('connectBtn').disabled = false;
          document.getElementById('disconnectBtn').disabled = true;
          addEvent('ì‹œìŠ¤í…œ', 'ì—°ê²°ì„ ëŠì—ˆìŠµë‹ˆë‹¤', 'warning');
        }
      }

      // ì„œë²„ ìƒíƒœ í™•ì¸
      async function checkStatus() {
        try {
          const response = await fetch('http://localhost:3090/sse/status');
          const data = await response.json();
          document.getElementById('clientCount').textContent =
            data.connectedClients;
          addEvent(
            'ìƒíƒœ í™•ì¸',
            `í˜„ì¬ ${data.connectedClients}ëª…ì˜ í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤`,
            'info',
          );
        } catch (error) {
          console.error('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
          addEvent('ì˜¤ë¥˜', 'ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        }
      }

      // ì´ë²¤íŠ¸ ì¶”ê°€
      function addEvent(title, data, type = 'data') {
        const eventsDiv = document.getElementById('events');

        // ì²« ì´ë²¤íŠ¸ë©´ placeholder ì œê±°
        if (eventCount === 0 && eventsDiv.querySelector('p')) {
          eventsDiv.innerHTML = '';
        }

        const eventDiv = document.createElement('div');
        eventDiv.className = 'event';

        // typeì— ë”°ë¼ í´ë˜ìŠ¤ ì¶”ê°€
        if (type === 'hello') {
          eventDiv.className = 'event hello';
        }

        const now = new Date().toLocaleTimeString('ko-KR');

        eventDiv.innerHTML = `
         <div class="event-time">${now} - ${title}</div>
         <div class="event-data">${data}</div>
       `;

        eventsDiv.insertBefore(eventDiv, eventsDiv.firstChild);

        // ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ í‘œì‹œ
        while (eventsDiv.children.length > 20) {
          eventsDiv.removeChild(eventsDiv.lastChild);
        }
      }

      // ì´ë²¤íŠ¸ ì§€ìš°ê¸°
      function clearEvents() {
        eventCount = 0;
        document.getElementById('events').innerHTML =
          '<p style="color: #999;">ì•„ì§ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      }

      // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° ì •ë¦¬
      window.addEventListener('beforeunload', () => {
        if (eventSource) {
          eventSource.close();
        }
      });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ ìƒíƒœ í™•ì¸
      window.addEventListener('load', () => {
        checkStatus();
      });
    </script>
  </body>
</html>
